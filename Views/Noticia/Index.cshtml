@model IEnumerable<ProjetoTesteICI.Models.Noticia>
@{
    ViewData["Title"] = "Notícias";
    var modalModel = new ProjetoTesteICI.ViewModels.NoticiaModalViewModel();
}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-dark">Notícias</h1>
    @Html.AntiForgeryToken()
    <button type="button" class="btn btn-primary btn-sm shadow-sm" id="btnCreate">
        <i class="bi bi-plus-lg me-1"></i> Nova Notícia
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle rounded shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Título</th>
                <th>Texto</th>
                <th>Autor</th>
                <th>Tags</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Id</td>
                    <td>@item.Titulo</td>
                    <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="@item.Texto">
                        @item.Texto
                    </td>
                    <td>@item.Usuario.Nome</td>
                    <td>
                        @if (item.NoticiaTags != null && item.NoticiaTags.Any())
                        {
                            @foreach (var tag in item.NoticiaTags.Select(nt => nt.Tag.Descricao))
                            {
                                <span class="badge bg-primary me-1">@tag</span>
                            }
                        }
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-info btnEdit" data-id="@item.Id">
                            Editar
                        </button>
                        |
                        <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger">Excluir</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@await Html.PartialAsync("_NoticiaModal", modalModel)

@section Scripts {
    <script>
        $(document).ready(function () {
            var token = $('input[name="__RequestVerificationToken"]').val();

            // ===== ABRIR MODAL DE CRIAÇÃO =====
            $(document).on('click', '#btnCreate', function () {
                $.get('/Noticia/GetModal', function (html) {
                    $('#noticiaModal').replaceWith(html);
                    var modalElement = document.getElementById('noticiaModal');
                    var modal = new bootstrap.Modal(modalElement);
                    modal.show();
                });
            });

            // ===== ABRIR MODAL DE EDIÇÃO =====
            $(document).on('click', '.btnEdit', function () {
                var id = $(this).data('id');
                $.get(`/Noticia/GetModal/${id}`, function (html) {
                    $('#noticiaModal').replaceWith(html);
                    var modalElement = document.getElementById('noticiaModal');
                    var modal = new bootstrap.Modal(modalElement);
                    modal.show();
                });
            });

            // ===== SUBMIT AJAX DO FORMULÁRIO (Create/Edit) =====
            $(document).on('submit', '#noticiaFormAjax', function (e) {
                e.preventDefault();

                var form = $(this);
                var url = form.attr('action');
                var data = form.serialize();

                $.ajax({
                    type: 'POST',
                    url: url,
                    data: data,
                    headers: {
                        'RequestVerificationToken': token
                    },
                    success: function () {
                        // Fecha o modal e recarrega a lista
                        var modalElement = document.getElementById('noticiaModal');
                        var modal = bootstrap.Modal.getInstance(modalElement);
                        modal.hide();
                        location.reload();
                    },
                    error: function (xhr) {
                        alert('Erro ao salvar: ' + xhr.responseText);
                    }
                });
            });
        });
    </script>
}
